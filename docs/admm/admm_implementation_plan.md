# ADMM-MPC控制器移植计划（修订版）

## 1. 项目概述

### 1.1 目标
将论文《Real-Time Deformable-Contact-Aware Model Predictive Control for Force-Modulated Manipulation》中的ADMM-MPC框架移植到Franka Emika机械臂，实现在保持力控制的同时精确跟踪自定义轨迹。

### 1.2 核心功能
- 基于ADMM的实时MPC控制（1kHz控制频率）
- Hertz接触模型实现
- 力-位混合控制与轨迹优化
- 支持自定义轨迹输入
- 动态力大小控制

##  更新日志

### 2024-05-XX
- 实现了自定义轨迹生成器接口
- 添加了多种轨迹类型支持（直线、矩形、八字形、自定义）
- 添加了从文件读取自定义路径功能
- 优化了轨迹可视化，实现历史轨迹点(100个)和未来预测点(200个)显示
- 添加了50ms轨迹预测减少跟踪延迟
- 改进了力控制参数，提高了响应速度
- 将探头颜色从红色改为白色，提高可视性
- 实现了恒定/正弦/阶跃/三维扰动力变化，参数可通过launch灵活配置
- 支持力噪音扰动与力变化类型独立叠加，便于鲁棒性实验
- launch和README文档完善，支持任意轨迹+任意力变化+扰动组合实验
- 已知问题：高幅值扰动下实际力跟踪有物理极限，建议合理设置参数
- 所有代码已上传至GitHub仓库

### 2024-05-15
- 实现了软接触力估计器节点，用于理论模型力与Gazebo仿真力对比
- 优化了力估计的计算与日志记录系统，支持多种数据分析
- 解决了实现中遇到的几个关键问题：
  - 修复了机器人位置信息获取问题：从FrankaState消息中提取变换矩阵中的位置数据
  - 调整力检测阈值：将力变化检测阈值和绝对力阈值分别调整为5N和8N
  - 优化接触检测逻辑：首次接触需同时满足力变化和力绝对值条件，后续状态维持仅依赖力绝对值
  - 移除基于深度的接触检测，只使用力变化和绝对力值判断
  - 增加调试信息输出，记录关键状态变化
- 问题汇总与后续优化方向：
  - 深度计算需进一步优化：考虑使用滤波和更精确的参考点
  - 力变化检测逻辑需调整：当前窗口大小和变化阈值可能需要根据不同材料特性进行适配
  - 运动安排逻辑需优化：考虑添加自适应运动控制，根据接触状态动态调整
  - 日志系统增强：添加更多调试信息，便于问题分析和算法改进

### 2024-05-20
- 重构了力轨迹生成相关代码，提高模块化：
  - 创建了独立的ForceGenerator类，从CircleController中提取力轨迹生成逻辑
  - 实现了ForceGenerator的头文件和源文件
  - 添加了初始化方法，支持从ROS参数服务器读取配置
  - 分离了力轨迹生成和力噪声生成功能
  - 在CircleController中集成ForceGenerator类
- 解决了编译问题：
  - 在CircleController中保留force_noise_enable_成员变量
  - 修复了CMakeLists.txt中的依赖关系
- 优化了代码结构和注释
- 确保修改前后功能一致性，验证了力轨迹生成在不同场景下的正确行为
- 分析了日志文件，确认力控制数据记录正常

### 2024-05-25
- 重构了日志记录系统，提升了代码模块化和可维护性：
  - 创建了独立的LogGenerator类，实现了日志功能的封装
  - 将原先在CircleController中的日志功能提取到单独的文件中
  - 新增了log_generator.h和log_generator.cpp文件
  - 在CMakeLists.txt中添加了log_generator.cpp的编译配置
  - 修改了CircleController类，整合LogGenerator功能
- 优化了日志记录机制：
  - 改进了日志文件的命名和创建逻辑
  - 增强了日志写入效率（批量写入和定期刷新缓冲区）
  - 完善了错误处理和异常捕获机制
  - 添加了更详细的元数据和实验参数记录
- 解决了潜在的资源泄漏问题，确保日志文件正确关闭
- 测试验证了重构后系统的正确性和稳定性

### 2024-05-26
- 解决了机械臂在接触软块后的"上下弹跳"问题:
  - 优化接触检测逻辑：为TRAJECTORY阶段和其他阶段设置不同的接触阈值（35mm/20mm）
  - 改进深度控制算法：添加深度滤波、排除极值的均值滤波、自适应增益和限位
  - 增强状态转换逻辑：使用深度方差<0.000008且持续1秒的条件判断稳定性
  - 调整轨迹生成策略：使用实际稳定深度（约23mm）替代目标深度（1mm）
  - 限制高度修正幅度：限制单次调整不超过0.3mm，减小校正率到30%
- 提高了轨迹执行过程中的稳定性:
  - 机械臂能够保持稳定接触并平稳执行XY平面轨迹
  - 接触力维持稳定，没有因深度变化导致的力波动
  - 在不同控制阶段间平滑过渡，没有状态抖动
- 记录了深度控制关键经验:
  - 软接触场景中深度滤波的重要性
  - 不同控制阶段需要不同的参数设置
  - 基于方差的稳定性判断优于基于目标值的判断


  ## 实现阶段

### 阶段1：已完成部分

#### 已实现功能
- ✅ 基础控制器框架（三阶段控制：接近、接触、圆周）
- ✅ Hertz接触模型
- ✅ 恒定力控制
- ✅ 圆周轨迹跟踪
- ✅ 数据记录系统
- ✅ 完整轨迹路径可视化系统
- ✅ 轨迹预测与延迟补偿（50ms预测 + 10ms前馈）
- ✅ 探头颜色优化（从红色改为白色，提高可视性）

### 阶段2：轨迹系统扩展（已全部完成）

#### 任务2.1：通用轨迹生成器
- ✅ 实现轨迹生成器接口
  - ✅ 添加直线轨迹生成
  - ✅ 添加矩形轨迹生成
  - ✅ 添加八字形轨迹生成
  - ✅ 添加自定义路径跟踪（从文件读取）
- ✅ 修改控制器支持动态轨迹切换
- ✅ 添加轨迹参数通过ROS参数服务器和launch文件配置

#### 任务2.2：动态力控制
- ✅ 实现力轨迹生成器
  - ✅ 支持恒定力
  - ✅ 支持正弦变化力
  - ✅ 支持阶跃力变化
  - ✅ 支持三维空间力噪音扰动（可选，独立于力变化类型）
- ✅ 实现力变化与位置轨迹的同步
- ✅ 添加力轨迹参数和噪音参数配置，支持launch灵活组合

#### 任务2.3：代码重构与模块化（全新任务）
- ✅ 实现日志生成器类
  - ✅ 提取日志功能到独立的LogGenerator类
  - ✅ 优化日志文件的创建和写入机制
  - ✅ 改进数据记录与存储格式
- ✅ 重构控制器代码，使用新的日志生成器
- ✅ 优化CMakeLists.txt，确保新组件正确编译

### 阶段3：ADMM-MPC框架实现

#### 任务3.1：软接触模型移植与扩展（预计1周）
- [ ] 创建独立的软接触模型类
  - [ ] 从ADMM项目移植Hertz接触理论核心公式
  - [ ] 实现基本接触力计算（法向力、摩擦力）
  - [ ] 添加接触状态估计功能
- [ ] 设计接触参数结构体
  - [ ] 支持从YAML配置文件读取参数
  - [ ] 与现有SDF模型参数保持一致

#### 任务3.2：基础MPC控制器框架（预计2周）
- [ ] 设计MPC控制器类结构
  - [ ] 实现状态预测方法
  - [ ] 提供参考轨迹生成接口
  - [ ] 集成软接触模型预测
- [ ] 实现有限时域滚动优化
  - [ ] 设计预测步长和优化窗口
  - [ ] 实现基本目标函数（轨迹误差、力跟踪误差）
  - [ ] 添加约束处理功能（状态约束、控制约束）
- [ ] 与现有控制器框架集成
  - [ ] 保持与三阶段控制流程兼容
  - [ ] 实现平滑过渡机制
- [ ] 简单优化求解器实现
  - [ ] 实现基于QP或梯度下降的简单求解器
  - [ ] 为后续ADMM优化器预留接口

#### 任务3.3：ADMM优化器开发（预计3周）
- [ ] 创建ADMM优化器类
  - [ ] 实现ADMM基本框架
  - [ ] 设计子问题分解结构
- [ ] 实现三个子问题求解
  - [ ] 动力学子问题（机器人+接触模型）
  - [ ] 逆运动学子问题（末端跟踪）
  - [ ] 约束投影子问题
- [ ] 迭代更新与收敛逻辑
  - [ ] 实现变量更新和残差计算
  - [ ] 添加收敛判断条件
  - [ ] 最大迭代次数与提前退出机制
- [ ] 优化性能与实时性
  - [ ] 矩阵运算优化
  - [ ] 并行计算机会（如可能）
  - [ ] 确保满足1kHz控制频率要求

#### 任务3.4：集成测试（预计1周）
- [ ] 创建MPC专用测试启动文件
  - [ ] 配置必要参数
  - [ ] 设置默认轨迹和力变化模式
- [ ] 基础功能测试
  - [ ] 静态环境中轨迹跟踪测试
  - [ ] 动态力变化测试
  - [ ] 外部扰动响应测试
- [ ] 比较性能评估
  - [ ] 与现有控制器对比
  - [ ] 生成分析报告

### 阶段4：性能优化与扩展功能

- [ ] 优化计算效率（确保1kHz控制频率）
- [ ] 改进鲁棒性（应对外部干扰）
- [ ] 参数自动调整


主要文件功能和说明：
@franka_gazebo是存放仿真有关文件的，提供Gazebo仿真环境、启动文件、物理模型和仿真配置
    启动器：franka_gazebo/launch/fr3_with_independent_probe.launch
    仿真世界文件：empty_with_soft_block.world

@franka_description 定义机器人的URDF/XACRO描述文件，包含几何形状、物理特性、关节连接等
    机械臂末端探头定义和修改：franka_description/robots/common/franka_robot.xacro
    外观的stl文件： probe_model/meshes/probe.stl 

@franka_example_controllers
   A[ROS应用层] --> B[franka_example_controllers]
    B --> C[franka_hw硬件抽象层]
    C --> D[Gazebo仿真/实体机器人]

circle_controller.cpp 
    作用：探头接触控制的主控制器，控制和机械臂完成任务中的所有运动控制和计算，完成上面提到的整个运动策略和过程，在fr3_with_independent_probe.launch中的作用：作为主要控制算法执行探头与软块的接触实验
    输入：
    1. franka::RobotState robot_state = state_handle_->getRobotState();
    位置信息：robot_state.O_T_EE (末端执行器位姿)
    关节角度：robot_state.q
    关节速度：robot_state.dq
    外部力/力矩：robot_state.O_F_ext_hat_K/
    2. 关节力矩命令 (发送到 franka_hw)：   joint_handles_[i].setCommand(tau_d_final(i));
    3. 机器人模型信息 (来自 franka_hw)
soft_contact_model.cpp 
    作用：只作为计算器，不作为控制器；通过获取深度和仿真器设置的弹性信息，用docs/Real-Time Deformable-Contact-Aware Model Predictive Control for Force-Modulated Manipulation论文中的模型和算法，实现软接触物理模型实现（Hertz-Hunt-Crossley模型）计算接触力和摩擦力等；
    输入是
    1. 配置文件和仿真文件中的接触系物理参数，比如模量等等
    2. 来自circle_controller.cpp 计算出来的深度信息和运动信息（比如后续需要计算摩擦力相关内容）
    输出：
    3. 计算得到的接触力数值estimated_force

trajectory_generator.cpp
    作用：轨迹生成算法，文件中定义了几个常用的规则轨迹，圆形、矩形、八字形、直线等轨迹，在探头深度稳定后轨迹运动阶段被调用，获取机械臂当前的位置和稳定平面后，生成运动的轨迹控制机械臂进行运动；
    输入：
    1. 来自circle_controller.cpp 的：
        a. 机械臂稳定的深度位置，作为运动的平面
        b. 机械臂初始状态下的z轴位置，作为规则运动的中心
    2. 来自配置文件的轨迹尺寸参数@simulation_parameters_config.yaml，比如半径等等
    输出：
    期望位置轨迹点 (Eigen::Vector3d)
    ROS可视化消息 (nav_msgs::Path)


log_generator.cpp
    作用：从控制器中获取信息，生成日志，数据记录和日志管理，记录力、位置、深度等实验数据
 

force_generator.cpp
    作用：力轨迹生成，生成恒定力、正弦力、阶跃力等力控制轨迹，在力控制模式下使用（默认都是深度控制）
示范文件：
cartesian_impedance_example_controller.cpp - 笛卡尔阻抗控制
force_example_controller.cpp - 基础力控制示例

/include 目录 - 接口定义

 /config 目录 - 参数配置
simulation_parameters_config.yaml
    作用：探头仿真的完整参数配置
    包含：
    轨迹参数（圆周半径、频率等）
    接触模型参数（杨氏模量、泊松比等）
    控制参数（深度控制、力控制）
    探头和软块位置配置
    在仿真中：为fr3_with_independent_probe.launch提供所有控制参数

/msg 目录 - 消息定义
JointTorqueComparison.msg
作用：定义关节力矩比较的消息格式
用途：用于调试和数据分析


franka_example_controllers_plugin.xml 
作用：ROS控制器插件注册文件
功能：向ROS系统注册所有可用控制器
重要性：让circle_controller能被ROS控制器管理器识别和加载
CMakeLists.txt & package.xml
作用：包构建配置和依赖管理
